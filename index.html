<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TchêCuidaMeu</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* [Styles unchanged from previous version] */
    :root {
      --primary-500: #10b981;
      --primary-700: #047857;
      --primary-100: #d1fae5;
      --neutral-50: #f8fafc;
      --neutral-900: #1f2a44;
      --accent-500: #f59e0b;
      --error-500: #ef4444;
      --neutral-200: #e5e7eb;
      --neutral-600: #4b5563;
      --neutral-400: #9ca3af;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background-color: var(--neutral-50); font-family: 'Inter', sans-serif; color: var(--neutral-900); line-height: 1.5; }
    .container { min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 1.5rem; }
    .login-box, .panel { background-color: #ffffff; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); width: 100%; max-width: 360px; transition: transform 0.2s ease, box-shadow 0.2s ease; }
    .panel { max-width: 960px; min-height: 600px; display: flex; flex-direction: column; }
    .panel:hover { box-shadow: 0 6px 24px rgba(0, 0, 0, 0.1); }
    .panel-content { flex: 1; }
    .panel-footer { margin-top: 1.5rem; text-align: right; }
    h1 { font-size: 1.75rem; font-weight: 600; color: var(--primary-700); text-align: center; margin-bottom: 1.5rem; }
    h2 { font-size: 1.25rem; font-weight: 500; color: var(--primary-700); margin-bottom: 1rem; }
    .welcome-text { color: var(--neutral-400); font-size: 0.875rem; text-align: center; margin-bottom: 1rem; }
    .menu-legend { color: var(--neutral-600); font-size: 0.875rem; margin-bottom: 0.5rem; }
    input, select, button { width: 100%; padding: 0.75rem; margin-top: 0.5rem; border: 1px solid var(--neutral-200); border-radius: 8px; font-size: 1rem; transition: border-color 0.2s ease, box-shadow 0.2s ease; }
    input:focus, select:focus { outline: none; border-color: var(--primary-500); box-shadow: 0 0 0 3px var(--primary-100); }
    button { background-color: var(--primary-500); color: #ffffff; border: none; font-weight: 500; cursor: pointer; transition: background-color 0.2s ease, transform 0.1s ease; }
    button:hover { background-color: var(--primary-700); transform: translateY(-1px); }
    button:active { transform: translateY(0); }
    button.logout { background-color: var(--error-500); }
    button.logout:hover { background-color: #dc2626; }
    button.back { background-color: var(--neutral-600); }
    button.back:hover { background-color: #374151; }
    .error { color: var(--error-500); text-align: center; margin-top: 0.75rem; font-size: 0.875rem; }
    ul { list-style-type: disc; padding-left: 1.5rem; margin-top: 0.75rem; }
    .chart-container { max-width: 100%; height: 300px; margin-top: 1.5rem; }
    .profile-pic { width: 120px; height: 120px; border-radius: 8px; object-fit: cover; border: 1px solid var(--neutral-200); }
    .section { margin-top: 1.5rem; padding: 1.5rem; border: 1px solid var(--neutral-200); border-radius: 8px; background-color: #ffffff; }
    .profile-container { display: flex; flex-wrap: wrap; gap: 1.5rem; align-items: flex-start; }
    .profile-info { flex: 1; min-width: 200px; }
    .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
    .menu-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
    .menu-grid button { padding: 1rem; font-size: 1rem; border-radius: 8px; }
    @media (max-width: 640px) {
      .login-box, .panel { padding: 1.25rem; max-width: 95%; }
      h1 { font-size: 1.5rem; }
      h2 { font-size: 1.125rem; }
      .chart-container { height: 240px; }
      .info-grid { grid-template-columns: 1fr; }
      .profile-container { flex-direction: column; }
      .menu-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div id="app" class="container"></div>
  <script>
    // Dados mockados
    let users = [
      {
        matricula: "12345",
        senha: "0102",
        nome: "João Silva",
        responsavel: "Maria Silva",
        endereco: "Rua Exemplo, 123, Porto Alegre, RS",
        escola: "Escola Municipal Exemplo",
        telefone: "(51) 99999-9999",
        tipoSanguineo: "O+",
        observacao: "Estudante com necessidade de acompanhamento regular",
        foto: null,
        consultas: [],
        observacoes: [],
        pressao: [],
        glicose: [],
        temperatura: [],
        batimentos: [],
        oxigenacao: [],
        tipo: "estudante"
      },
      {
        matricula: "123",
        senha: "123",
        nome: "Ana Pereira",
        email: "ana.pereira@example.com",
        telefone: "(51) 98888-8888",
        instituicao: "UFRGS",
        curso: "Medicina",
        dataNascimento: "1998-05-15",
        foto: null,
        consultas: [],
        observacoes: [],
        pressao: [],
        glicose: [],
        temperatura: [],
        batimentos: [],
        oxigenacao: [],
        tipo: "universitario"
      }
    ];
    let currentUser = null;
    let currentProfile = null;
    let currentScreen = "main";

    function sanitizeInput(input) {
      if (!input) return input;
      return input.replace(/[`);('"{}\[\]\\]/g, '');
    }

    function formatarDataBrasileira(dataISO) {
      if (!dataISO) return "";
      const [ano, mes, dia] = dataISO.split("-");
      return `${dia}/${mes}/${ano}`;
    }

    function render() {
      const app = document.getElementById("app");
      if (!app) {
        console.error("Elemento #app não encontrado!");
        return;
      }
      if (!currentUser) {
        app.innerHTML = `
          <div class="login-box">
            <h1>TchêCuidaMeu</h1>
            <p class="welcome-text">Bem-vindo ao sistema de gestão de saúde escolar!</p>
            <div id="error" class="error"></div>
            <div style="margin-top: 1.5rem;">
              <h2>Login</h2>
              <select id="user-type">
                <option value="admin">Administrador</option>
                <option value="estudante">Estudante</option>
                <option value="universitario">Universitário(a)</option>
              </select>
              <input id="login-id" type="text" placeholder="Usuário ou Matrícula">
              <input id="login-pass" type="password" placeholder="Senha">
              <button onclick="handleLogin()">Entrar</button>
            </div>
          </div>
        `;
      } else if (currentUser === "admin") {
        if (currentScreen === "main") {
          app.innerHTML = `
            <div class="panel">
              <div class="panel-content">
                <h1>Painel do Administrador</h1>
                <div class="section">
                  <h2>Menu de Ações</h2>
                  <p class="menu-legend">Selecione uma ação para gerenciar perfis, consultas ou dados de saúde.</p>
                  <div class="menu-grid">
                    <button onclick="currentScreen='addEstudante';render()">Cadastrar Estudante</button>
                    <button onclick="currentScreen='addUniversitario';render()">Cadastrar Universitário(a)</button>
                    <button onclick="currentScreen='editProfile';render()">Editar Perfil</button>
                    <button onclick="currentScreen='addConsulta';render()">Agendar Consulta</button>
                    <button onclick="currentScreen='addSaude';render()">Adicionar Dados de Saúde</button>
                    <button onclick="currentScreen='viewCharts';render()">Visualizar Gráficos</button>
                    <button onclick="currentScreen='generateReport';render()">Gerar Relatório por Matrícula</button>
                  </div>
                </div>
              </div>
              <div class="panel-footer">
                <button class="logout" onclick="handleLogout()">Sair</button>
              </div>
            </div>
          `;
        } else if (currentScreen === "generateReport") {
          app.innerHTML = `
            <div class="panel">
              <div class="panel-content">
                <h1>Painel do Administrador</h1>
                <div class="section">
                  <h2>Gerar Relatório de Estudante</h2>
                  <input id="report-matricula" type="text" placeholder="Matrícula do Estudante">
                  <button onclick="generateStudentReport()">Gerar Relatório</button>
                  <button class="back" onclick="currentScreen='main';render()">Voltar</button>
                </div>
              </div>
              <div class="panel-footer">
                <button class="logout" onclick="handleLogout()">Sair</button>
              </div>
            </div>
          `;
        } else if (currentScreen === "addEstudante") {
          app.innerHTML = `
            <div class="panel">
              <div class="panel-content">
                <h1>Painel do Administrador</h1>
                <div class="section">
                  <h2>Cadastro de Novo Estudante</h2>
                  <div class="info-grid">
                    <div>
                      <input id="new-matricula" type="text" placeholder="Matrícula">
                      <input id="new-nome" type="text" placeholder="Nome">
                      <input id="new-senha" type="password" placeholder="Senha">
                      <input id="new-responsavel" type="text" placeholder="Responsável">
                    </div>
                    <div>
                      <input id="new-endereco" type="text" placeholder="Endereço">
                      <input id="new-escola" type="text" placeholder="Escola">
                      <input id="new-telefone" type="text" placeholder="Telefone">
                      <select id="new-tipo-sanguineo">
                        <option value="A+">A+</option>
                        <option value="A-">A-</option>
                        <option value="B+">B+</option>
                        <option value="B-">B-</option>
                        <option value="AB+">AB+</option>
                        <option value="AB-">AB-</option>
                        <option value="O+">O+</option>
                        <option value="O-">O-</option>
                        <option value="-">-</option>
                      </select>
                      <input id="new-observacao" type="text" placeholder="Observação">
                      <input id="new-foto" type="file" accept="image/*">
                    </div>
                  </div>
                  <button onclick="handleAddEstudante()">Cadastrar Estudante</button>
                  <button class="back" onclick="currentScreen='main';render()">Voltar</button>
                </div>
              </div>
              <div class="panel-footer">
                <button class="logout" onclick="handleLogout()">Sair</button>
              </div>
            </div>
          `;
        } else if (currentScreen === "addUniversitario") {
          app.innerHTML = `
            <div class="panel">
              <div class="panel-content">
                <h1>Painel do Administrador</h1>
                <div class="section">
                  <h2>Cadastro de Novo Universitário(a)</h2>
                  <div class="info-grid">
                    <div>
                      <input id="uni-matricula" type="text" placeholder="Matrícula">
                      <input id="uni-senha" type="password" placeholder="Senha">
                      <input id="uni-nome" type="text" placeholder="Nome">
                      <input id="uni-email" type="email" placeholder="E-mail">
                      <input id="uni-telefone" type="text" placeholder="Telefone">
                    </div>
                    <div>
                      <input id="uni-instituicao" type="text" placeholder="Instituição">
                      <input id="uni-curso" type="text" placeholder="Curso">
                      <input id="uni-data-nascimento" type="date" placeholder="Data de Nascimento">
                      <input id="uni-foto" type="file" accept="image/*">
                    </div>
                  </div>
                  <button onclick="handleAddUniversitario()">Cadastrar Universitário(a)</button>
                  <button class="back" onclick="currentScreen='main';render()">Voltar</button>
                </div>
              </div>
              <div class="panel-footer">
                <button class="logout" onclick="handleLogout()">Sair</button>
              </div>
            </div>
          `;
        } else if (currentScreen === "editProfile") {
          app.innerHTML = `
            <div class="panel">
              <div class="panel-content">
                <h1>Painel do Administrador</h1>
                <div class="section">
                  <h2>Editar Perfil</h2>
                  <input id="edit-matricula" type="text" placeholder="Matrícula do Aluno">
                  <button onclick="loadEditForm()">Carregar Perfil</button>
                  <div id="edit-form" style="display: none;">
                    <h3 id="edit-title"></h3>
                    <div id="edit-fields" class="info-grid"></div>
                    <button onclick="handleEditProfile()">Salvar Alterações</button>
                  </div>
                  <button class="back" onclick="currentScreen='main';render()">Voltar</button>
                </div>
              </div>
              <div class="panel-footer">
                <button class="logout" onclick="handleLogout()">Sair</button>
              </div>
            </div>
          `;
        } else if (currentScreen === "addConsulta") {
          app.innerHTML = `
            <div class="panel">
              <div class="panel-content">
                <h1>Painel do Administrador</h1>
                <div class="section">
                  <h2>Agendamento de Consultas</h2>
                  <input id="consulta-matricula" type="text" placeholder="Matrícula do Aluno">
                  <input id="consulta-data" type="date">
                  <input id="consulta-hora" type="time">
                  <input id="consulta-tipo" type="text" placeholder="Médico ou Especialidade">
                  <input id="consulta-descricao" type="text" placeholder="Descrição da Consulta">
                  <button onclick="handleAddConsulta()">Agendar Consulta</button>
                  <button class="back" onclick="currentScreen='main';render()">Voltar</button>
                </div>
              </div>
              <div class="panel-footer">
                <button class="logout" onclick="handleLogout()">Sair</button>
              </div>
            </div>
          `;
        } else if (currentScreen === "addSaude") {
          app.innerHTML = `
            <div class="panel">
              <div class="panel-content">
                <h1>Painel do Administrador</h1>
                <div class="section">
                  <h2>Adição de Dados de Saúde</h2>
                  <input id="saude-matricula" type="text" placeholder="Matrícula do Aluno">
                  <input id="observacao" type="text" placeholder="Adicionar Observação">
                  <input id="pressao" type="text" placeholder="Pressão (ex: 120/80)">
                  <input id="glicose" type="text" placeholder="Glicose (mg/dL)">
                  <input id="temperatura" type="text" placeholder="Temperatura (°C)">
                  <input id="batimentos" type="text" placeholder="Batimentos (BPM)">
                  <input id="oxigenacao" type="text" placeholder="Oxigenação (%)">
                  <button onclick="handleAddSaude()">Adicionar Dados Saúde</button>
                  <button class="back" onclick="currentScreen='main';render()">Voltar</button>
                </div>
              </div>
              <div class="panel-footer">
                <button class="logout" onclick="handleLogout()">Sair</button>
              </div>
            </div>
          `;
        } else if (currentScreen === "viewCharts") {
          app.innerHTML = `
            <div class="panel">
              <div class="panel-content">
                <h1>Painel do Administrador</h1>
                <div class="section">
                  <h2>Visualização de Gráficos</h2>
                  <input id="chart-matricula" type="text" placeholder="Matrícula do Aluno">
                  <button onclick="updateChart()">Atualizar Gráfico</button>
                  <button class="back" onclick="currentScreen='main';render()">Voltar</button>
                  <div class="chart-container">
                    <canvas id="healthChart"></canvas>
                  </div>
                </div>
              </div>
              <div class="panel-footer">
                <button class="logout" onclick="handleLogout()">Sair</button>
              </div>
            </div>
          `;
          updateChart();
        }
      } else if (currentUser === "estudante") {
        app.innerHTML = `
          <div class="panel">
            <div class="panel-content">
              <h1>Painel do Estudante</h1>
              <div class="section">
                <h2>Dados Cadastrais</h2>
                <div class="profile-container">
                  ${currentProfile?.foto ? `<img src="${currentProfile.foto}" alt="Foto de perfil" class="profile-pic">` : `<p>Sem foto de perfil</p>`}
                  <div class="profile-info">
                    <div class="info-grid">
                      <div>
                        <p><strong>Nome:</strong> ${sanitizeInput(currentProfile?.nome)}</p>
                        <p><strong>Responsável:</strong> ${sanitizeInput(currentProfile?.responsavel)}</p>
                        <p><strong>Telefone:</strong> ${currentProfile?.telefone}</p>
                        <p><strong>Endereço:</strong> ${sanitizeInput(currentProfile?.endereco)}</p>
                        <p><strong>Tipo Sanguíneo:</strong> ${currentProfile?.tipoSanguineo}</p>
                      </div>
                      <div>
                        <p><strong>Matrícula:</strong> ${currentProfile?.matricula}</p>
                        <p><strong>Escola:</strong> ${sanitizeInput(currentProfile?.escola) || 'Não informado'}</p>
                        <p><strong>Observação:</strong> ${sanitizeInput(currentProfile?.observacao) || 'Nenhuma'}</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="section">
                <h2>Consultas Agendadas</h2>
                ${currentProfile?.consultas?.length > 0 ? `
                  <ul>
                    ${currentProfile.consultas.map(c => `<li>${formatarDataBrasileira(c.data)} às ${c.hora} - ${sanitizeInput(c.tipo)}: ${sanitizeInput(c.descricao) || 'Sem descrição'}</li>`).join('')}
                  </ul>
                ` : `<p>Sem consultas agendadas</p>`}
              </div>
              <div class="section">
                <h2>Observações Gerais</h2>
                ${currentProfile?.observacoes?.length > 0 ? `
                  <ul>
                    ${currentProfile.observacoes.map(o => `<li>${o.data}: ${sanitizeInput(o.texto)}</li>`).join('')}
                  </ul>
                ` : `<p>Sem observações</p>`}
              </div>
              <div class="section">
                <h2>Acompanhamento de Saúde</h2>
                <div class="chart-container" id="chart-container">
                  <canvas id="healthChart"></canvas>
                </div>
              </div>
            </div>
            <div class="panel-footer">
              <button class="logout" onclick="handleLogout()">Sair</button>
            </div>
          </div>
        `;
        updateChart();
      } else if (currentUser === "universitario") {
        if (currentScreen === "main") {
          app.innerHTML = `
            <div class="panel">
              <div class="panel-content">
                <h1>Painel do Universitário(a)</h1>
                <div class="section">
                  <h2>Informações Pessoais</h2>
                  <div class="profile-container">
                    ${currentProfile?.foto ? `<img src="${currentProfile.foto}" alt="Foto de perfil" class="profile-pic">` : `<p>Sem foto de perfil</p>`}
                    <div class="profile-info">
                      <div class="info-grid">
                        <div>
                          <p><strong>Nome:</strong> ${sanitizeInput(currentProfile?.nome)}</p>
                          <p><strong>Matrícula:</strong> ${currentProfile?.matricula}</p>
                          <p><strong>E-mail:</strong> ${currentProfile?.email}</p>
                          <p><strong>Telefone:</strong> ${currentProfile?.telefone || 'Não informado'}</p>
                        </div>
                        <div>
                          <p><strong>Instituição:</strong> ${sanitizeInput(currentProfile?.instituicao) || 'Não informado'}</p>
                          <p><strong>Curso:</strong> ${sanitizeInput(currentProfile?.curso) || 'Não informado'}</p>
                          <p><strong>Data de Nascimento:</strong> ${formatarDataBrasileira(currentProfile?.dataNascimento)}</p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="section">
                  <h2>Menu de Ações</h2>
                  <p class="menu-legend">Escolha uma opção para gerenciar consultas ou dados de saúde de estudantes.</p>
                  <div class="menu-grid">
                    <button onclick="currentScreen='addConsulta';render()">Agendar Consulta</button>
                    <button onclick="currentScreen='addSaude';render()">Adicionar Dados de Saúde</button>
                    <button onclick="currentScreen='viewCharts';render()">Visualizar Gráficos</button>
                    <button onclick="currentScreen='generateReportUni';render()">Gerar Relatório por Matrícula</button>
                  </div>
                </div>
              </div>
              <div class="panel-footer">
                <button class="logout" onclick="handleLogout()">Sair</button>
              </div>
            </div>
          `;
        } else if (currentScreen === "addConsulta") {
          app.innerHTML = `
            <div class="panel">
              <div class="panel-content">
                <h1>Painel do Universitário(a)</h1>
                <div class="section">
                  <h2>Agendamento de Consultas para Estudantes</h2>
                  <input id="uni-consulta-matricula" type="text" placeholder="Matrícula do Estudante">
                  <input id="uni-consulta-data" type="date">
                  <input id="uni-consulta-hora" type="time">
                  <input id="uni-consulta-tipo" type="text" placeholder="Médico ou Especialidade">
                  <input id="uni-consulta-descricao" type="text" placeholder="Descrição da Consulta">
                  <button onclick="handleAddConsulta('uni')">Agendar Consulta</button>
                  <button class="back" onclick="currentScreen='main';render()">Voltar</button>
                </div>
              </div>
              <div class="panel-footer">
                <button class="logout" onclick="handleLogout()">Sair</button>
              </div>
            </div>
          `;
        } else if (currentScreen === "addSaude") {
          app.innerHTML = `
            <div class="panel">
              <div class="panel-content">
                <h1>Painel do Universitário(a)</h1>
                <div class="section">
                  <h2>Adição de Dados de Saúde para Estudantes</h2>
                  <input id="uni-saude-matricula" type="text" placeholder="Matrícula do Estudante">
                  <input id="uni-observacao" type="text" placeholder="Adicionar observação do dia">
                  <input id="uni-pressao" type="text" placeholder="Pressão (ex: 120/80)">
                  <input id="uni-glicose" type="text" placeholder="Glicose (mg/dL)">
                  <input id="uni-temperatura" type="text" placeholder="Temperatura (°C)">
                  <input id="uni-batimentos" type="text" placeholder="Batimentos Cardíacos (BPM)">
                  <input id="uni-oxigenacao" type="text" placeholder="Oxigenação (%)">
                  <button onclick="handleAddSaude('uni')">Adicionar Dados</button>
                  <button class="back" onclick="currentScreen='main';render()">Voltar</button>
                </div>
              </div>
              <div class="panel-footer">
                <button class="logout" onclick="handleLogout()">Sair</button>
              </div>
            </div>
          `;
        } else if (currentScreen === "viewCharts") {
          app.innerHTML = `
            <div class="panel">
              <div class="panel-content">
                <h1>Painel do Universitário(a)</h1>
                <div class="section">
                  <h2>Visualização de Gráficos</h2>
                  <input id="uni-chart-matricula" type="text" placeholder="Matrícula do Estudante">
                  <button onclick="updateChart()">Atualizar Gráfico</button>
                  <button class="back" onclick="currentScreen='main';render()">Voltar</button>
                  <div class="chart-container">
                    <canvas id="healthChart"></canvas>
                  </div>
                </div>
              </div>
              <div class="panel-footer">
                <button class="logout" onclick="handleLogout()">Sair</button>
              </div>
            </div>
          `;
          updateChart();
        } else if (currentScreen === "generateReportUni") {
          app.innerHTML = `
            <div class="panel">
              <div class="panel-content">
                <h1>Painel do Universitário(a)</h1>
                <div class="section">
                  <h2>Gerar Relatório de Estudante</h2>
                  <input id="report-matricula" type="text" placeholder="Matrícula do Estudante">
                  <button onclick="generateStudentReport()">Gerar Relatório</button>
                  <button class="back" onclick="currentScreen='main';render()">Voltar</button>
                </div>
              </div>
              <div class="panel-footer">
                <button class="logout" onclick="handleLogout()">Sair</button>
              </div>
            </div>
          `;
        }
      }
    }

    function handleLogin() {
      const userType = document.getElementById("user-type")?.value;
      const loginId = document.getElementById("login-id")?.value;
      const loginPass = document.getElementById("login-pass")?.value;
      if (!loginId || !loginPass) {
        document.getElementById("error").textContent = "Preencha todos os campos!";
        return;
      }
      if (userType === "admin") {
        if (loginId === "admin" && loginPass === "admin") {
          currentUser = "admin";
          currentScreen = "main";
          document.getElementById("error").textContent = "";
          render();
        } else {
          document.getElementById("error").textContent = "Usuário ou senha incorretos!";
        }
      } else {
        const profile = users.find(u => u.matricula === loginId && u.senha === loginPass && u.tipo === userType);
        if (profile) {
          currentUser = userType;
          currentProfile = profile;
          currentScreen = "main";
          document.getElementById("error").textContent = "";
          render();
        } else {
          document.getElementById("error").textContent = "Matrícula ou senha incorretos!";
        }
      }
    }

    function handleLogout() {
      currentUser = null;
      currentProfile = null;
      currentScreen = "main";
      render();
    }

    function handleAddEstudante() {
      const matricula = document.getElementById("new-matricula")?.value;
      const nome = sanitizeInput(document.getElementById("new-nome")?.value);
      const senha = document.getElementById("new-senha")?.value;
      const responsavel = sanitizeInput(document.getElementById("new-responsavel")?.value);
      const endereco = sanitizeInput(document.getElementById("new-endereco")?.value);
      const escola = sanitizeInput(document.getElementById("new-escola")?.value);
      const telefone = sanitizeInput(document.getElementById("new-telefone")?.value);
      const tipoSanguineo = document.getElementById("new-tipo-sanguineo")?.value;
      const observacao = sanitizeInput(document.getElementById("new-observacao")?.value);
      const fileInput = document.getElementById("new-foto");
      if (!matricula || !nome || !senha || !responsavel || !endereco || !escola || !telefone || !tipoSanguineo) {
        alert("Preencha todos os campos obrigatórios!");
        return;
      }
      if (users.find(u => u.matricula === matricula)) {
        alert("Matrícula já cadastrada!");
        return;
      }
      const newEstudante = {
        matricula,
        nome,
        senha,
        responsavel,
        endereco,
        escola,
        telefone,
        tipoSanguineo,
        observacao,
        foto: null,
        consultas: [],
        observacoes: [],
        pressao: [],
        glicose: [],
        temperatura: [],
        batimentos: [],
        oxigenacao: [],
        tipo: "estudante"
      };
      if (fileInput?.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
          newEstudante.foto = e.target.result;
          users.push(newEstudante);
          currentScreen = "main";
          render();
        };
        reader.onerror = function() {
          alert("Erro ao carregar a foto!");
        };
        reader.readAsDataURL(fileInput.files[0]);
      } else {
        users.push(newEstudante);
        currentScreen = "main";
        render();
      }
    }

    function handleAddUniversitario() {
      const matricula = document.getElementById("uni-matricula")?.value;
      const senha = document.getElementById("uni-senha")?.value;
      const nome = sanitizeInput(document.getElementById("uni-nome")?.value);
      const email = document.getElementById("uni-email")?.value;
      const telefone = sanitizeInput(document.getElementById("uni-telefone")?.value);
      const instituicao = sanitizeInput(document.getElementById("uni-instituicao")?.value);
      const curso = sanitizeInput(document.getElementById("uni-curso")?.value);
      const dataNascimento = document.getElementById("uni-data-nascimento")?.value;
      const fileInput = document.getElementById("uni-foto");
      if (!matricula || !senha || !nome || !email || !telefone || !instituicao || !curso || !dataNascimento) {
        alert("Preencha todos os campos obrigatórios!");
        return;
      }
      if (users.find(u => u.matricula === matricula)) {
        alert("Matrícula já cadastrada!");
        return;
      }
      const newUniversitario = {
        matricula,
        senha,
        nome,
        email,
        telefone,
        instituicao,
        curso,
        dataNascimento,
        foto: null,
        consultas: [],
        observacoes: [],
        pressao: [],
        glicose: [],
        temperatura: [],
        batimentos: [],
        oxigenacao: [],
        tipo: "universitario"
      };
      if (fileInput?.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
          newUniversitario.foto = e.target.result;
          users.push(newUniversitario);
          currentScreen = "main";
          render();
        };
        reader.onerror = function() {
          alert("Erro ao carregar a foto!");
        };
        reader.readAsDataURL(fileInput.files[0]);
      } else {
        users.push(newUniversitario);
        currentScreen = "main";
        render();
      }
    }

    function loadEditForm() {
      const matricula = document.getElementById("edit-matricula")?.value;
      const user = users.find(u => u.matricula === matricula);
      if (!user) {
        alert("Usuário não encontrado!");
        return;
      }
      const editForm = document.getElementById("edit-form");
      const editTitle = document.getElementById("edit-title");
      const editFields = document.getElementById("edit-fields");
      editForm.style.display = "block";
      if (user.tipo === "estudante") {
        editTitle.textContent = "Editar Estudante";
        editFields.innerHTML = `
          <div>
            <input id="edit-matricula" type="text" placeholder="Matrícula" value="${matricula}" readonly>
            <input id="edit-nome" type="text" placeholder="Nome" value="${sanitizeInput(user.nome)}">
            <input id="edit-senha" type="password" placeholder="Senha" value="${user.senha}">
            <input id="edit-responsavel" type="text" placeholder="Responsável" value="${sanitizeInput(user.responsavel)}">
          </div>
          <div>
            <input id="edit-endereco" type="text" placeholder="Endereço" value="${sanitizeInput(user.endereco)}">
            <input id="edit-escola" type="text" placeholder="Escola" value="${sanitizeInput(user.escola) || ''}">
            <input id="edit-telefone" type="text" placeholder="Telefone" value="${sanitizeInput(user.telefone)}">
            <select id="edit-tipo-sanguineo">
              <option value="A+" ${user.tipoSanguineo === "A+" ? "selected" : ""}>A+</option>
              <option value="A-" ${user.tipoSanguineo === "A-" ? "selected" : ""}>A-</option>
              <option value="B+" ${user.tipoSanguineo === "B+" ? "selected' : ''}>B+</option>
              <option value="B-" ${user.tipoSanguineo === "B-" ? "selected" : ""}>B-</option>
              <option value="AB+" ${user.tipoSanguineo === "AB+" ? "selected" : ""}>AB+</option>
              <option value="AB-" ${user.tipoSanguineo === "AB-" ? "selected" : ""}>AB-</option>
              <option value="O+" ${user.tipoSanguineo === "O+" ? "selected" : ""}>O+</option>
              <option value="O-" ${user.tipoSanguineo === "O-" ? "selected" : ""}>O-</option>
              <option value="-" ${user.tipoSanguineo === "-" ? "selected" ? ""}>--</option>
            </select>
            <input id="edit-observação" type="text" placeholder="Observação" value="${sanitizeInput(user.observacao) || ''}">
            <input id="edit-foto" type="file" accept="image/*">
          </div>
        `;
      } else if (user.tipo === "universitario") {
        {
          editTitle.textContent = "Editar Universitário(a)";
          editFields.innerHTML = `
            <div>
              <input id="edit-matricula" type="text" placeholder="Matrícula" value="${matricula}" readonly>
              <input id="edit-senha" type="password" placeholder="text" value="${user.senha}">
              <input id="edit-nome" type="text" placeholder="Nome" value="${sanitizeInput(user.nome)}">
              <input id="edit-email" type="email" placeholder="E-mail" value="${user.email}">
              <input id="edit-telefone" type="text" placeholder="Telefone" value="${sanitizeInput(user.telefone)}">
            </div>
            <div>
              <div>
                <input id="edit-instituicao" type="text" placeholder="Instituição" value="${sanitizeInput(user.instituicao) || ''}">
                <input id="edit-curso" type="text" placeholder="Curso" value="${sanitizeInput(user.curso) || ''}">
                <input id="edit-data-nascimento" type="date" placeholder="Data de Nascimento" value="${user.dataNascimento}">
                <input id="edit-foto" type="file" accept="image/*">
              </div>
            `;
          }
        }
      }

    function handleEditProfile() {
      const matricula = document.getElementById("edit-matricula")?.value;
      const userIndex = users.findIndex(u => u.matricula === matricula);
      if (userIndex === -1) {
        alert("Usuário não encontrado!");
        return;
      }
      const user = users[userIndex];
      const user = users.find(u=>u.matricula === matricula); 
      const fileInput = document.getElementById("edit-foto");
      const editForm = document.getElementById("edit-form");
      if (user.tipo === "estudante") {
        const nome = sanitizeInput(document.getElementById("edit-nome")?.value);
        const senha = document.getElementById("edit-senha")?.value;
        const responsavel = sanitizeInput(document.getElementById("edit-responsavel")?.value);
        const nome = sanitizeInput(document.getName("edit-nome")?.value); 
        const endereco = sanitizeInput(document.getElementById("edit-endereco")?.value);
        const escola = sanitizeInput(document.getElementById("edit-escola")?.value);
        const telefone = sanitizeInput(document.getElementById("edit-telefone")?.value);
        const tipoSanguineo = document.getElementById("edit-tipo-sanguineo")?.value;
        const observacao = sanitizeInput(document.getElementById("edit-observacao")?.value);
        if (!nome || !senha || !responsavel || !endereco || !escola || !telefone || !tipoSanguineo) {
          alert("Por favor, preencha todos os campos obrigatórios!"); 
          return;
        }
        const updatedEstudante = {
          ...user,
          nome,
          senha,
          responsavel,
          endereco,
          escola,
          telefone,
          tipoSanguineo,
          observacao
        };
        if (fileInput?.files[0]) {
          const reader = new FileReader();
          reader.onload = function(e) {
            updatedEstudante.foto = e.target.result;
            users[userIndex] = updatedEstudante;
            if (editForm) editForm.style.display = "none";
            currentScreen = "main";
            render();
          };
          reader.onerror = function() {
            alert("Erro ao carregar a foto!");
          };
          reader.readAsDataURL(fileInput.files[0]);
        } else {
          users[userIndex] = updatedEstudante;
          if (editForm) editForm.style.display = "none';
            currentScreen = none;
            render();
          }
        } else if (user.tipo === "universitario") {
          const senha = document.getElementById("edit-senha")?.value;
          const nome = document.getElementById("edit-nome")?.value;
          const email = sanitizeInput(document.getElementById("edit-email")?.value);
          const telefone = document.getElementById("edit-telefone")?.value;
          const instituicao = document.getElementById("edit-instituicao")?.value;
          const curso = document.getElementById("edit-curso")?.value;
          const dataNascimento = document.getElementById("edit-data-nascimento")?.value;
          if (!nome || !senha || !email || !telefone || !instituicao || !curso || !dataNascimento) {
            alert("Preencha todos os campos obrigatórios!");
            return;
          }
          const updatedUniversitario = {
            ...user,
            senha,
            nome,
            email,
            telefone,
            instituicao,
            curso,
            dataNascimento
          };
          if (fileInput?.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
              updatedUniversitario.foto = e.target.result;
              users[userIndex] = updatedUniversitario;
              users[userIndex] = updatedUniversitario;
              if (editForm) editForm.style.display = 'none';
              currentScreen = "main";
              render();
            };
            reader.onerror = function() {
              alert("Erro ao carregar a foto!");
            };
            reader.readAsDataURL(fileInput.files[0]);
          } else {
            users[userIndex] = updatedUniversitario;
            if (editForm) editForm.style.display = "none";
            currentScreen = "main";
            render();
          }
        }
      }

      function handleAddConsulta(prefix = '') {
        const matriculaInput = document.getElementById(`${prefix ? prefix + '-' : ''}consulta-matricula`);
        const dataInput = document.getElementById(`${prefix ? prefix + '-' : ''}consulta-data`);
        const horaInput = document.getElementById(`${prefix ? prefix + '-' : ''}consulta-hora`);
        const tipoInput = document.getElementById(`${prefix ? prefix + '-' : ''}consulta-tipo`);
        const descricaoInput = document.getElementById(`${prefix ? prefix + '-' : ''}consulta-descrição`);

        if (!matriculaInput || !dataInput || !horaInput || !tipoInput || !descriçãoInput) {
          console.error("Um ou mais campos não encontrados:", {
            matricula: !!matriculaInput,
            data: !!dataInput,
            hora: !!horaInput,
            tipo: !!tipoInput,
            descrição: !!descriçãoInput
          });
          alert("Erro interno: um ou mais campos não foram encontrados!");
          return;
        }

        const matricula = sanitizeInput(matriculaInput.value.trim());
        const data = dataInput.value.trim();
        const hora = horaInput.value.trim();
        const tipo = sanitizeInput(tipoInput.value.trim());
        const descrição = sanitizeInput(descriçãoInput.value.trim());

        if (!matricula || !data || !hora || !tipo || !descrição) {
          console.error("Campos faltando:", { matricula, data, hora, tipo, descrição });
          alert("Preencha todos os campos da consulta!");
          return;
        }

        const userIndex = users.findIndex(u => u.matricula === matricula && u.tipo === "estudante");
        if (userIndex === -1) {
          alert("Estudante não encontrado!");
          return;
        }

        users[userIndex].consultas.push({
          data,
          hora,
          tipo,
          descrição
        });

        alert("Consulta agendada com sucesso!");
        currentScreen = "main";
        render();
      }

      function handleAddSaude(prefix = '') {
        const matricula = document.getElementById(`${prefix ? prefix + '-' : ''}saude-matricula`)?.value;
        const userIndex = users.findIndex(u => u.matricula === matricula && u.tipo === "estudante");
        if (userIndex === -1) {
          alert("Estudante não encontrado!");
          return;
        }
        const observacao = sanitizeInput(document.getElementById(`${prefix ? prefix + '-' : ''}observacao`)?.value);
        const pressao = sanitizeInput(document.getElementById(`${prefix ? prefix + '-' : ''}pressao`)?.value);
        const glicose = sanitizeInput(document.getElementById(`${prefix ? prefix + '-' : ''}glicose`)?.value);
        const temperatura = sanitizeInput(document.getElementById(`${prefix ? prefix + '-' : ''}temperatura`)?.value);
        const batimentos = sanitizeInput(document.getElementById(`${prefix ? prefix + '-' : ''}batimentos`)?.value);
        const oxigenacao = sanitizeInput(document.getElementById(`${prefix ? prefix + '-' : ''}oxigenacao`)?.value);

        if (pressao && !/^\d+\/\d+$/.test(pressao)) {
          alert("Formato de pressão inválido! Use o formato sistólica/diastólica (ex: 120/80).");
          return;
        }
        if (glicose && (isNaN(glicose) || glicose <= 0)) {
          alert("Glicose deve ser um número positivo!");
          return;
        }
        if (temperatura && (isNaN(temperatura) || temperatura <= 0)) {
          alert("Temperatura deve ser um número positivo!");
          return;
        }
        if (batimentos && (!/^\d+$/.test(batimentos) || batimentos < 30 || batimentos > 200)) {
          alert("Batimentos cardíacos devem ser um número inteiro entre 30 e 200 BPM!");
          return;
        }
        if (oxigenacao && (!/^\d+$/.test(oxigenacao) || oxigenacao < 70 || oxigenacao > 100)) {
          alert("Oxigenação deve ser um número inteiro entre 70 e 100%!");
          return;
        }

        const timestamp = new Date().toLocaleString('pt-BR');
        if (observacao) users[userIndex].observacoes.push({ data: timestamp, texto: observacao });
        if (pressao) users[userIndex].pressao.push({ data: timestamp, valor: pressao });
        if (glicose) users[userIndex].glicose.push({ data: timestamp, valor: glicose });
        if (temperatura) users[userIndex].temperatura.push({ data: timestamp, valor: temperatura });
        if (batimentos) users[userIndex].batimentos.push({ data: timestamp, valor: batimentos });
        if (oxigenacao) users[userIndex].oxigenacao.push({ data: timestamp, valor: oxigenacao });

        alert("Dados de saúde adicionados com sucesso!");
        currentScreen = "main";
        render();
      }

      let chartInstance = null;
      function updateChart(matricula = null) {
        let selectedMatricula = matricula;
        if (!selectedMatricula) {
          if (currentUser === "admin") {
            selectedMatricula = document.getElementById("chart-matricula")?.value;
          } else if (currentUser === "estudante") {
            selectedMatricula = currentProfile?.matricula;
          } else if (currentUser === "universitario") {
            selectedMatricula = document.getElementById("uni-chart-matricula")?.value;
          }
        }
        const user = users.find(u => u.matricula === selectedMatricula && u.tipo === "estudante");
        if (!user) {
          if (!matricula) alert("Estudante não encontrado!");
          return null;
        }

        if (chartInstance) {
          chartInstance.destroy();
        }

        const ctx = matricula ? document.createElement('canvas').getContext('2d') : document.getElementById("healthChart")?.getContext("2d");
        if (!ctx) {
          console.error("Contexto do canvas não encontrado!");
          return null;
        }

        const canvas = ctx.canvas;
        if (matricula) {
          canvas.width = 600;
          canvas.height = 400;
        }

        const timestamps = new Set();
        ['pressao', 'glicose', 'temperatura', 'batimentos', 'oxigenacao'].forEach(key => {
          user[key].forEach(item => timestamps.add(item.data));
        });
        const labels = Array.from(timestamps).sort();

        if (!labels.length) {
          console.warn("Nenhum dado de saúde disponível para o gráfico.");
          return null;
        }

        const systolicData = labels.map(ts => {
          const entry = user.pressao.find(p => p.data === ts);
          if (!entry || !entry.valor) return null;
          try {
            const parts = entry.valor.split('/');
            if (parts.length !== 2) return null;
            return parseInt(parts[0]) || 0;
          } catch (e) {
            console.error("Erro ao parsear pressão sistólica:", entry.valor, e);
            return null;
          }
        });
        const diastolicData = labels.map(ts => {
          const entry = user.pressao.find(p => p.data === ts);
          if (!entry || !entry.valor) return null;
          try {
            const parts = entry.valor.split('/');
            if (parts.length !== 2) return null;
            return parseInt(parts[1]) || 0;
          } catch (e) {
            console.error("Erro ao parsear pressão diastólica:", entry.valor, e);
            return null;
          }
        });
        const glucoseData = labels.map(ts => {
          const entry = user.glicose.find(g => g.data === ts);
          return entry ? parseFloat(entry.valor) || 0 : null;
        });
        const temperatureData = labels.map(ts => {
          const entry = user.temperatura.find(t => t.data === ts);
          return entry ? parseFloat(entry.valor) || 0 : null;
        });
        const heartRateData = labels.map(ts => {
          const entry = user.batimentos.find(b => b.data === ts);
          return entry ? parseInt(entry.valor) || 0 : null;
        });
        const oxygenData = labels.map(ts => {
          const entry = user.oxigenacao.find(o => o.data === ts);
          return entry ? parseInt(entry.valor) || 0 : null;
        });

        if (!systolicData.some(v => v !== null) && !diastolicData.some(v => v !== null) &&
            !glucoseData.some(v => v !== null) && !temperatureData.some(v => v !== null) &&
            !heartRateData.some(v => v !== null) && !oxygenData.some(v => v !== null)) {
          console.warn("Nenhum dado válido para o gráfico.");
          return null;
        }

        console.log("Chart Data:", { labels, systolicData, diastolicData, glucoseData, temperatureData, heartRateData, oxygenData });

        chartInstance = new Chart(ctx, {
          type: "line",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Pressão Sistólica",
                data: systolicData,
                borderColor: "#60a5fa",
                fill: false,
                yAxisID: 'y',
                spanGaps: true
              },
              {
                label: "Pressão Diastólica",
                data: diastolicData,
                borderColor: "#1e40af",
                fill: false,
                yAxisID: 'y',
                spanGaps: true
              },
              {
                label: "Glicose",
                data: glucoseData,
                borderColor: "#f59e0b",
                fill: false,
                yAxisID: 'y',
                spanGaps: true
              },
              {
                label: "Temperatura",
                data: temperatureData,
                borderColor: "#ef4444",
                fill: false,
                yAxisID: 'y',
                spanGaps: true
              },
              {
                label: "Batimentos Cardíacos",
                data: heartRateData,
                borderColor: "#8b5cf6",
                fill: false,
                yAxisID: 'y1',
                spanGaps: true
              },
              {
                label: "Oxigenação",
                data: oxygenData,
                borderColor: "#ec4899",
                fill: false,
                yAxisID: 'y1',
                spanGaps: true
              }
            ]
          },
          options: {
            responsive: !matricula,
            maintainAspectRatio: false
            scales: {
            y: {
              beginAtZero: false,
              position: 'left',
              title: {
                display: true,
                text: 'Pressão (mmHg), Glicose (mg/dL), Temp (°C)'
              }
            },
            y1: {
              beginAtZero: false,
              position: 'right',
              title: {
                display: true,
                text: 'Batimentos (BPM), Oxigenação (%)'
              },
              grid: {
                drawOnChartArea: false
              }
            },
            x: {
              title: {
                display: true,
                text: 'Data'
              }
            }
          }
        }
      });
    }

    try {
      render();
    } catch (error) {
      console.error("Erro ao inicializar a aplicação:", error);
    }
  </script>
</body>
</html>